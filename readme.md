## 摘要
    本应用旨在


## 引言


WebGPU是一个新的Web API，它允许Web应用程序（特别是游戏）直接使用GPU来进行高性能的图形和计算。与WebGL不同，WebGPU被设计为更接近于现代GPU架构的编程模型，可以更好地利用现代GPU的硬件特性。

WebGPU由W3C提供支持，已经成为WebGPU社区组的一部分。它的目标是提供一种跨平台的图形和计算API，可以在不同的设备和浏览器中使用。WebGPU提供了一种更现代的编程模型，比OpenGL或DirectX 11/12更具可移植性和性能。

WebGPU在WebAssembly和WebVR等Web技术中发挥着越来越重要的作用，可以帮助开发者创建更加优秀的Web游戏和应用程序，提升用户体验。同时，WebGPU也有助于为现代浏览器提供更好的硬件加速支持，使其更适合处理复杂的图形和计算任务。

地形是由高程图数据生成的，这些数据通常是以像素为单位的灰度图像。游戏使用了地形网格，通过高程图数据对地形进行细分和平滑处理，生成了可视化的3D地形。

## 需求分析

## 程序功能


## 程序设计

### cube-sphere

cube-sphere 是一种表达球面的方法，即将一个立方体的六个面映射到球面上。对于立方体表面任意一点P，可通过公式映射到球面：P.normalized()，其中P.normalied()表示P的单位向量。
然而，该映射方式会使得棱角附近的点映射后会挤压在一起，因此需要对映射前的点进行一定的变换，使得映射后的点更加均匀分布。这里采用的是COBE变换。COBE变换的优点在于能保持映射后的面积不变，缺点时这个变换是不完全可逆。

### 地形四叉树

为了使相机在拉近拉远时，星球的地形细节都足够。需要根据相机的距离来动态加载对应分辨率的地形数据。相机拉远时能看到整个星球的轮廓，拉近时则会加载更高分辨率的地形数据，同时剔除视野外的地形数据。这里的地形是对现实地形的简化，是表面，不考虑洞穴等情况，也就是说从星球中心向外发射射线，射线与地形表面只有一个交点。

将立方体映射为球体，球体表面便能用六个正方形覆盖，每个正方形可以划分成网格，每个网格的中心点就是采样点。

观察一个正方形，可以用田字对正方形划分成四个正方形区域，如此可以递归下去， 区域之间以划分关系作为父子关系，这些区域就可以构成一颗四叉树。

用一颗满四叉树来存储一个方形区域的不同分辨率的数据，不同分辨率地形数据存储在树的不同层，根存储最小分辨率的数据。所有叶子节点构成一个网格，存储最大分辨率的地形数据，或者说原始地形数据。对原始地形数据修改时，会修改对应的叶子节点。当叶子节点修改时，叶子节点的祖先节点数据也需要修改，称这一过程为地形数据更新回溯。

可以用数组存储一棵满四叉树，则有父节点索引 = (子节点索引 - 1) / 4。

为便于讨论，命名每个独立的地形数据块为Chunk。实际上每个chunk就对应地形四叉树的一个节点。

### 项目结构

底层渲染接口采用webgpu， 框架则使用wgpu。Rust为开发语言。shader语言为wgsl。

模块可分为gpu模块，命令行模块，数学模块，网格模块，星球模块，世界模块。

gpu模块：对底层渲染接口进行抽象，简化渲染流程

命令行模块：对命令行参数进行解析。

数学模块：提供数学函数等接口，定义好坐标系

网格模块： 提供可程序化构建的网格

星球模块：定义星球数据结构，管理地形数据，定义相关渲染管线。

世界模块：定义世界数据结构，管理星球，定义相关渲染管线。

##### GPU模块

GPU模块定义一个GpuAgent结构，该结构存储窗口句柄，窗口大小，GPU设备句柄，深度贴图等。

在渲染中一个常见的需求是渲染一个覆盖整个屏幕的三角形，这样可以在着色器中直接对屏幕像素进行处理，实现屏幕的后处理效果，例如泛光效果，或是延迟渲染。

在GPU并行编程中，输入输出数据都为buffer，处理程序是pipeline。渲染时，将网格数据存储到显存的指定buffer中，pipeline
读取数据输出每个像素到 frame buffer，最终呈现到屏幕。


#### 命令行模块

为了使程序更容易调试，需要通过命令行来传递参数以使程序有更灵活的入口，例如可以通过命令行来指定星球的半径，星球的分辨率等。
命令行程序是一种以文本方式与用户交互的程序，它通过在命令行界面（也称为终端或命令行界面）中输入命令来执行各种任务。
命令行模块负责解析命令行参数，将参数传递给世界模块。具体来说，有四个命令，分别是创建星球，列出星球，初始化世界， 渲染世界。

#### 数学模块

数学模块定义了坐标系，向量，矩阵，四元数，以及一些常用的数学函数。
其中定义了一个AxisNormal结构，该结构是一个枚举类型，枚举了立方体的六个面，并确定每个面的法线方向，切线方向等。这是为了更好地统一在生成cube-sphere地形时的坐标系。并统一处理地形数据的
